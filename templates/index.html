<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParcelNotify Pro - Flask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .tab-btn.active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <nav class="sticky top-0 z-40 bg-white border-b border-slate-200 px-4 h-16 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 text-blue-600 font-bold text-xl">
            <i class="fas fa-box-open"></i>
            <span>ParcelNotify</span>
        </div>
        <div id="nav-tabs" class="flex bg-slate-100 p-1 rounded-xl">
            <button onclick="switchTab('scanner')" class="tab-btn active px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Input</button>
            <button onclick="switchTab('students')" class="tab-btn text-slate-500 px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Directory</button>
            <button onclick="switchTab('history')" class="tab-btn text-slate-500 px-4 py-1.5 rounded-lg text-sm font-bold transition-all">History</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 sm:p-6">
        <!-- MESSAGES -->
        <div id="status-msg" class="hidden mb-6 p-4 rounded-xl border flex items-center gap-3 animate-in fade-in"></div>

        <!-- SCANNER VIEW -->
        <section id="tab-scanner" class="tab-content block">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold mb-4 text-slate-700 flex items-center gap-2">
                        <i class="fas fa-camera text-blue-500"></i> Entry Method
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer aspect-square rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center hover:bg-slate-50 hover:border-blue-300 transition-all group">
                            <i class="fas fa-qrcode text-3xl text-slate-300 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">AI Scan</span>
                            <input type="file" accept="image/*" class="hidden" onchange="uploadImage(event)">
                        </label>
                        <button onclick="manualForm()" class="aspect-square rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center hover:bg-slate-50 hover:border-blue-300 transition-all group">
                            <i class="fas fa-file-signature text-3xl text-slate-300 mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Manual</span>
                        </button>
                    </div>
                    <div id="preview-container" class="mt-4 hidden">
                        <img id="img-preview" src="" class="w-full rounded-xl border border-slate-200 aspect-video object-cover">
                    </div>
                </div>

                <div id="log-details" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold mb-4 text-slate-700">Parcel Details</h3>
                    <div id="form-container" class="space-y-4">
                        <div class="text-center py-20 text-slate-400 opacity-60">
                            <i class="fas fa-box text-4xl mb-4"></i>
                            <p class="text-sm font-bold uppercase tracking-wider">Start Input</p>
                            <p class="text-xs">Scan a label or choose manual entry</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- STUDENTS VIEW -->
        <section id="tab-students" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="font-bold text-lg">Student Directory</h2>
                    <button onclick="showStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i> Add Student
                    </button>
                </div>
                <div id="students-list" class="overflow-x-auto">
                    <!-- Populated via JS -->
                </div>
            </div>
        </section>

        <!-- HISTORY VIEW -->
        <section id="tab-history" class="tab-content hidden">
            <div id="history-list" class="space-y-6">
                <!-- Grouped items -->
            </div>
        </section>
    </main>

    <script>
        // Use absolute URLs to avoid "Failed to parse URL" errors in sandboxed/blob environments
        const getUrl = (path) => {
            try {
                return new URL(path, window.location.origin).href;
            } catch (e) {
                return path;
            }
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            event.target.classList.add('active');
            
            if(tabId === 'history') loadHistory();
            if(tabId === 'students') loadStudents();
        }

        function showMessage(type, text) {
            const el = document.getElementById('status-msg');
            el.className = `mb-6 p-4 rounded-xl border flex items-center gap-3 animate-in fade-in ${
                type === 'success' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'
            }`;
            el.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span class="text-sm font-medium">${text}</span>`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        async function uploadImage(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('img-preview');
            preview.src = URL.createObjectURL(file);
            document.getElementById('preview-container').classList.remove('hidden');

            const container = document.getElementById('form-container');
            container.innerHTML = `<div class="text-center py-20"><i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i><p class="text-xs font-bold text-slate-400">AI IS ANALYZING...</p></div>`;

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const res = await fetch(getUrl('/api/scan'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({image: base64})
                    });
                    const data = await res.json();
                    renderForm(data.ocr || {}, data.matched_student);
                } catch (err) {
                    showMessage('error', 'Failed to connect to AI service');
                    manualForm();
                }
            };
            reader.readAsDataURL(file);
        }

        function manualForm() {
            document.getElementById('preview-container').classList.add('hidden');
            renderForm({}, null);
        }

        function renderForm(ocr, match) {
            const container = document.getElementById('form-container');
            container.innerHTML = `
                <div class="space-y-4 animate-in slide-in-from-bottom-2">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Recipient Name</label>
                        <input id="f-name" value="${ocr.name || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="e.g. Rahul Kumar">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Roll Number</label>
                            <input id="f-roll" value="${ocr.rollNo || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono" placeholder="CS2301">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">AWB/Tracking</label>
                            <input id="f-awb" value="${ocr.awb || ''}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono" placeholder="AWB123...">
                        </div>
                    </div>
                    
                    ${match ? `
                        <div class="bg-green-50 border border-green-100 p-3 rounded-xl flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <div>
                                <p class="text-sm font-bold text-green-800">${match.name}</p>
                                <p class="text-[10px] text-green-600 font-bold uppercase">${match.email}</p>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-[11px] text-slate-500">
                            <i class="fas fa-info-circle mr-1"></i> No matching student found. Logging as guest.
                        </div>
                    `}
                    
                    <button onclick="confirmParcel(${match?.id || 'null'})" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i> Log & Notify
                    </button>
                </div>
            `;
        }

        async function confirmParcel(studentId) {
            const payload = {
                name: document.getElementById('f-name').value,
                rollNo: document.getElementById('f-roll').value,
                awb: document.getElementById('f-awb').value,
                student_id: studentId
            };

            if(!payload.name) return showMessage('error', 'Name is required');

            try {
                const res = await fetch(getUrl('/api/parcels'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                showMessage('success', `Parcel logged as ${data.serial_no}`);
                document.getElementById('form-container').innerHTML = `<div class="text-center py-20 text-slate-400 opacity-60"><i class="fas fa-check-circle text-4xl mb-4 text-green-500"></i><p class="text-xs font-bold uppercase">Success</p></div>`;
                document.getElementById('preview-container').classList.add('hidden');
            } catch (err) {
                showMessage('error', 'Failed to save parcel');
            }
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-600"></i></div>`;
            
            try {
                const res = await fetch(getUrl('/api/parcels'));
                const groups = await res.json();
                
                if(Object.keys(groups).length === 0) {
                    list.innerHTML = `<div class="text-center py-20 text-slate-300 border-2 border-dashed rounded-2xl"><i class="fas fa-history text-4xl mb-2"></i><p class="font-bold text-xs uppercase">No records found</p></div>`;
                    return;
                }

                list.innerHTML = Object.entries(groups).map(([month, items]) => `
                    <div class="space-y-3">
                        <div class="flex items-center gap-4">
                            <span class="text-[10px] font-bold uppercase text-slate-400 tracking-widest whitespace-nowrap">${month}</span>
                            <div class="h-px w-full bg-slate-200"></div>
                        </div>
                        <div class="grid gap-3">
                            ${items.map(p => `
                                <div class="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm hover:shadow-md transition-shadow">
                                    <div class="flex gap-3 items-center">
                                        <div class="bg-blue-50 text-blue-600 p-2.5 rounded-lg"><i class="fas fa-box"></i></div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-0.5">
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded font-mono uppercase">${p.serial_no}</span>
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase ${p.picked ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${p.status}</span>
                                            </div>
                                            <p class="font-bold text-sm text-slate-800">${p.name}</p>
                                        </div>
                                    </div>
                                    <button onclick="markPick(${p.id})" class="text-[10px] font-bold uppercase tracking-widest px-4 py-2 rounded-lg transition-all ${
                                        p.picked ? 'bg-slate-100 text-slate-500' : 'bg-blue-600 text-white shadow-lg shadow-blue-50'
                                    }">
                                        ${p.picked ? 'Undo' : 'Mark Picked'}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-xl text-sm">Error loading history.</div>`;
            }
        }

        async function markPick(id) {
            try {
                await fetch(getUrl(`/api/parcels/${id}/pick`), {method: 'POST'});
                loadHistory();
            } catch (err) {
                showMessage('error', 'Update failed');
            }
        }

        async function loadStudents() {
            const list = document.getElementById('students-list');
            try {
                const res = await fetch(getUrl('/api/students'));
                const students = await res.json();
                
                list.innerHTML = `
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-bold uppercase text-slate-500">
                            <tr>
                                <th class="px-6 py-4 tracking-wider">Student Info</th>
                                <th class="px-6 py-4 tracking-wider">Roll</th>
                                <th class="px-6 py-4 tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${students.map(s => `
                                <tr class="hover:bg-slate-50 transition-colors text-sm">
                                    <td class="px-6 py-4">
                                        <p class="font-bold text-slate-800">${s.name}</p>
                                        <p class="text-xs text-slate-400">${s.email}</p>
                                    </td>
                                    <td class="px-6 py-4 font-mono text-xs">${s.roll_no}</td>
                                    <td class="px-6 py-4 text-right">
                                        <button class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                list.innerHTML = `<div class="p-6 text-center text-slate-400">Failed to load directory.</div>`;
            }
        }
    </script>
</body>
</html>
